
###R??? ????????? ?????? ?????? ?????????리오 만들???
###???계학??? 201811526 ?????????

###Chapter 8 ????????? 분석 ??? ???각화??????
############################################################
##8.1 종목?????? ????????? 분석
setwd("C:\\Users\\eunju\\Desktop\\3학년 2학기\\학부연구생")
library(stringr)
KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1,
                      stringsAsFactors = FALSE)
KOR_sector = read.csv('data/KOR_sector.csv', row.names = 1,
                      stringsAsFactors = FALSE)
KOR_ticker$'종목코드' =
  str_pad(KOR_ticker$'종목코드', 6,'left', 0)
KOR_sector$'CMP_CD' =
  str_pad(KOR_sector$'CMP_CD', 6, 'left', 0)

#*_join: ????????? ???치기
#inner_join();교집???, full_join;(???집합), right_join(???측기준)
library(dplyr)
data_market = left_join(KOR_ticker, KOR_sector, #거래??????커기준(좌측기???) ????????? ???치기
                        by = c('종목코드' = 'CMP_CD',
                               '종목명' = 'CMP_KOR'))
head(data_market)
glimpse(data_market)

#rename: ????????? ??????
head(names(data_market), 10)
data_market = data_market %>%
  rename(`시가총액` = `시가총액.원.`)
head(names(data_market), 10)

#distinct: 고유??? ?????? ->NA??? 존재 ??????
data_market %>%
  distinct(SEC_NM_KOR) %>% c()

#select: ????????? ??? ??????
data_market %>%
  select(`종목명`) %>% head()
data_market %>%
  select(`종목명`, `PBR`, `SEC_NM_KOR`) %>% head()
data_market %>%
  select(starts_with('시')) %>% head()  #'???'??? ???????????? ????????? ??????
data_market %>%
  select(ends_with('R')) %>% head() #'R'??? ????????? ????????? ??????
data_market %>%
  select(contains('가')) %>% head() #'가'가 ????????? ????????? ??????

#mutate: ??? ?????? ??? ????????? 변???
data_market = data_market %>%
  mutate('PBR' = as.numeric(PBR),
         'PER' = as.numeric(PER),
         'ROE' = PBR / PER,
         'ROE' = round(ROE, 4),
         'size' = ifelse(`시가총액` >=
                           median(`시가총액`, na.rm = TRUE),
                         'big', 'small')
  )
data_market %>%
  select(`종목명`, `ROE`, `size`) %>% head()

#filter: ?????????
data_market %>%
  select(`종목명`, `PBR`) %>%
  filter(`PBR` < 1) %>% head() #???????????? 좋다 - 1미만??? 경우; ???부가치보??? 주???가 ??????
                               #그렇?????? ?????? 매수?????? ??????
                               #??????????????? 기업??? 가치인 경우 ?????? ?????????, 부채??? 반영???지 ?????? ??????
data_market %>%
  select(`종목명`, `PBR`, `PER`, `ROE`) %>%
  filter(PBR < 1 & PER < 20 & ROE > 0.1 ) %>% 
  arrange(PER) %>% head() #PER : ???????????? 좋다(10???????????? 괜춘)
                                                     #ROE : ???????????? 좋다 - ??????채수???률보??? ????????? ??????

#summarize,arrange
data_market %>%
  summarize(PBR_max = max(PBR, na.rm = TRUE),
            PBR_min = min(PBR, na.rm = TRUE))
data_market %>%
  select(`종목???`,PBR) %>%
  arrange(PBR) %>% #???름차???(???????????? 좋음)-????????????,?????????,???????????????
  head(5)
data_market %>%
  select(`종목???`,ROE) %>%
  arrange(desc(ROE)) %>% #???림차???(???????????? 좋음)-???????????????,???진중공업
  head(5)

#row_number: ??????계산
data_market %>%
  mutate(PBR_rank = row_number(PBR)) %>%
  select(`종목???`, PBR, PBR_rank) %>% #???????????? 좋음
  arrange(PBR) %>%
  head(5)
data_market %>%
  mutate(POE_rank = row_number(desc(ROE))) %>%
  select(`종목???`, ROE, POE_rank) %>% #???????????? 좋음
  arrange(desc(ROE)) %>%
  head(5)

#ntile: 분위???계산
data_market %>%
  mutate(PBR_tile = ntile(PBR, n = 5)) %>% #n ???????????? 몇분??? ??????지 결정 - ???름차???
  select(PBR, PBR_tile) %>%
  head()

#group_by
data_market %>%
  group_by('SEC_NM_KOR') %>%
  summarize(n()) #n(): 그룹??? ???????????? 개수
data_market %>%
  group_by('SEC_NM_KOR') %>% 
  summarize(PBR_median = median(PBR, na.rm = TRUE)) %>% #그룹??? 중앙???
  arrange(PBR_median)
data_market %>%
  group_by(`??????구분`, 'SEC_NM_KOR') %>%
  summarize(PBR_median = median(PBR, na.rm = TRUE)) %>%
  arrange(PBR_median)

############################################################
##8.2 ggplot() 기초
############################################################
##8.3 종목?????? ???각화
#geom_point : ROE??? PBR 관???
library(ggplot2)
ggplot(data_market, aes(x = ROE, y = PBR)) +
  geom_point()+
  coord_cartesian(xlim = c(0, 0.30), ylim = c(0, 3)) #극단??? ?????? ???거위??? xlim,ylim 지???

ggplot(data_market, aes(x = ROE, y = PBR,
                        color = `??????구분`,
                        shape = `??????구분`)) +
  geom_point() +
  geom_smooth(method = 'lm') + #?????????귀???
  coord_cartesian(xlim = c(0, 0.30), ylim = c(0, 3))

#geom_histogram : PBR
ggplot(data_market, aes(x = PBR)) +
  geom_histogram(binwidth = 0.1) + #binwidth; 막?????? ??????
  coord_cartesian(xlim = c(0, 10))

ggplot(data_market, aes(x = PBR)) +
  geom_histogram(aes(y = ..density..), #밀?????????
                 binwidth = 0.1,
                 color = 'sky blue', fill = 'sky blue') + 
  coord_cartesian(xlim = c(0, 10)) +
  geom_density(color = 'red') + #밀???곡선
  geom_vline(aes(xintercept = median(PBR, na.rm = TRUE)), #x축으??? PBR중앙??? ???로선
             color = 'blue') +
  geom_text(aes(label = median(PBR, na.rm = TRUE), #그림??? 글?????????
                x = median(PBR, na.rm = TRUE), y = 0.05),
            col = 'black', size = 6, hjust = -0.5)

#geom_boxplot : sector??? PBR
ggplot(data_market, aes(x = SEC_NM_KOR, y = PBR)) +
  geom_boxplot() +
  coord_flip() #x??? y??? ???집어 ??????

#dplyr??? ggplot : sector??? PBR/ROE
data_market %>%
  filter(!is.na(SEC_NM_KOR)) %>% #NA가 ?????? sector ??????
  group_by(SEC_NM_KOR) %>%
  summarize(ROE_sector = median(ROE, na.rm = TRUE),
            PBR_sector = median(PBR, na.rm = TRUE)) %>%
  ggplot(aes(x = ROE_sector, y = PBR_sector,
             color = SEC_NM_KOR, label = SEC_NM_KOR)) +
  geom_point(size=10) +
  geom_text(color = 'black', size = 6, vjust = 1.3) +
  theme(legend.position = 'bottom',
        legend.title = element_blank())

#geom_bar
data_market %>%
  group_by(SEC_NM_KOR) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = SEC_NM_KOR, y = n)) +
  geom_bar(stat = 'identity') + #y축에 ???????????? n????????? 그?????? ???????????? ??????
  theme_classic() #배경??????

data_market %>%
  filter(!is.na(SEC_NM_KOR)) %>%
  group_by(SEC_NM_KOR) %>%
  summarize(n = n()) %>%
  ggplot(aes(x = reorder(SEC_NM_KOR, n), y = n, label = n)) + #n????????? ?????????
  geom_bar(stat = 'identity') +
  geom_text(color = 'black', size = 4, hjust = -0.3) +
  xlab(NULL) + #???벨삭???
  ylab(NULL) +
  coord_flip() +
  scale_y_continuous(expand = c(0, 0, 0.1, 0)) + #그림??? 간격 ?????????
  theme_classic()

############################################################
##8.4 주??? ??? ????????? ???각화
#주??? 그래???
library(quantmod)
library(ggplot2)
getSymbols('SPY') #SPY ????????? ??????로드 - xts??????
prices = Cl(SPY) #종?????? ???????????? ???????????? 추출
plot(prices, main = 'Price')
SPY %>%
  ggplot(aes(x = Index, y = SPY.Close)) +
  geom_line()

#??????????????? 그래??? - ????????? 기간??? ????????? ?????? 가???
library(dygraphs)
dygraph(prices) %>%
  dyRangeSelector()

library(highcharter)
highchart(type = 'stock') %>%
  hc_add_series(prices) %>%
  hc_scrollbar(enabled = FALSE)

library(plotly)
p = SPY %>%
  ggplot(aes(x = Index, y = SPY.Close)) +
  geom_line()
ggplotly(p)

prices %>% 
  fortify.zoo %>% #???????????? ????????? ?????????지 ????????? ??????
  plot_ly(x= ~Index, y = ~SPY.Close ) %>%
  add_lines()

#????????? ????????? ????????????
library(PerformanceAnalytics)
ret_yearly = prices %>%
  Return.calculate() %>%
  apply.yearly(., Return.cumulative) %>% #????????? ??????률계???
  round(4) %>%
  fortify.zoo() %>% #???간데????????? index?????? ??????
  mutate(Index = as.numeric(substring(Index, 1, 4))) #Index?????? 1~4번째 글??? 뽑기

ggplot(ret_yearly, aes(x = Index, y = SPY.Close)) +
  geom_bar(stat = 'identity') +
  scale_x_continuous(breaks = ret_yearly$Index, #x축에 모든 ??????가 출력?????????
                     expand = c(0.01, 0.01)) +
  geom_text(aes(label = paste(round(SPY.Close * 100, 2), "%"), #??????별수??????% ??????
                vjust = ifelse(SPY.Close >= 0, -0.5, 1.5)), #0보다 ?????? ???쪽에, ????????? ??????쪽에
            position = position_dodge(width = 1),
            size = 3) +
  xlab(NULL) + ylab(NULL)

######
KOR_code = function(code){
  library(stringr)
  KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE)
  KOR_ticker$'종목코드' = as.factor(str_pad(KOR_ticker$'종목코드', 6,'left', 0))
  KOR_price = read.csv('data/KOR_price.csv',stringsAsFactors = FALSE)
  
  codex = paste0("X",code)
  date = as.Date(KOR_price[,1])
  price = KOR_price[,codex]
  data = data.frame(date,price)
  
  library(plotly)
  data %>% 
    fortify.zoo %>%
    plot_ly(x= ~date, y = ~price ) %>%
    add_lines()
} 
KOR_code("005930")

KOR_name = function(name){
  library(stringr)
  KOR_ticker = read.csv('data/KOR_ticker.csv', row.names = 1, stringsAsFactors = FALSE)
  KOR_ticker$'종목코드' = as.factor(str_pad(KOR_ticker$'종목코드', 6,'left', 0))
  KOR_price = read.csv('data/KOR_price.csv',stringsAsFactors = FALSE)
  code = KOR_ticker[which(KOR_ticker$종목???==name),'종목코드']
  
  codex = paste0("X",code)
  date = as.Date(KOR_price[,1])
  price = KOR_price[,codex]
  data = data.frame(date,price)
  
  library(quantmod)
  library(plotly)
  data %>% 
    fortify.zoo %>%
    plot_ly(x= ~date, y = ~price ) %>%
    add_lines()
}

KOR_name("??????금융지???")
